<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Lua</title>



    <link rel="stylesheet" href="tachyons.css">
    <style>
        * {
            box-sizing: border-box;
        }

        .flex-fair {
            flex-basis: 1px;
            flex-grow: 1;
            flex-shrink: 1;
        }
    </style>
</head>

<body>
    <div class="flex absolute absolute--fill pa3">
        <div class="flex-fair flex flex-column overflow-hidden">
            <div id="program" class="flex-grow-1"></div>
            <button id="run" class="mt3 pa3">Run</button>
        </div>
        <div class="flex-fair pa3">
            <pre id="output"></pre>
        </div>
    </div>

    <script src="fengari-web.js"></script>
    <script src="monaco/min/vs/loader.js"></script>
    <script>
        const luaconf  = fengari.luaconf;
        const lua      = fengari.lua;
        const lauxlib  = fengari.lauxlib;
        const lualib   = fengari.lualib;

        const log = console.log;
        function write(str) {
            output.innerText += str + '\n';
        }

        // Fengari just calls console.log, so this is what we have to do...
        console.log = (...args) => {
            write(args[0]);
            log(...args);
        }

        let editor;
        require.config({ paths: { vs: 'monaco/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            const startValue = window.localStorage.getItem('latest') || 'print("Hello world!")';

            editor = monaco.editor.create(document.querySelector('#program'), {
                value: startValue,
                language: 'lua',
                automaticLayout: true,
                theme: 'vs-dark',
                minimap: {
                    enabled: false,
                },
            });

            editor.onDidChangeModelContent(() => {
                window.localStorage.setItem('latest', editor.getValue());
            });

            const runButton = document.querySelector('#run');
            const output = document.querySelector('#output');

            runButton.addEventListener('click', () => {
                output.innerText = '';
                try {
                    const L = lauxlib.luaL_newstate();
                    lualib.luaL_openlibs(L);
                    // lua.lua_sethook(L, null, lua.LUA_MASKCOUNT, 1);

                    const loadResult = lauxlib.luaL_loadstring(L, fengari.to_luastring(editor.getValue()));
                    if (loadResult) {
                        const errmsg = lua.lua_tojsstring(L, -1);
                        write(errmsg);
                        throw new Error(`Failed to load Lua program (err code ${loadResult}): ${errmsg}`);
                    }

                    const runResult = lua.lua_pcall(L, 0, lua.LUA_MULTRET, 0);
                    if (runResult) {
                        const errmsg = lua.lua_tojsstring(L, -1);
                        write(errmsg);
                        throw new Error(`Failed to run Lua program (err code ${runResult}): ${errmsg}`);
                    }
                } catch (e) {
                    console.error(e);
                }
            });
        });

        function dumpstack(L, name) {
            originalLog('dumping stack', name);
            const top = lua.lua_gettop(L);
            for (let i = 1; i <= top; i++) {
                let val;
                switch (lua.lua_type(L, i)) {
                case lua.LUA_TNUMBER:
                    val = lua.lua_tonumber(L, i);
                    break;
                case lua.LUA_TSTRING:
                    val = lua.lua_tojsstring(L, i);
                    break;
                case lua.LUA_TBOOLEAN:
                    val = lua.lua_toboolean(L, i) ? "true" : "false";
                    break;
                case lua.LUA_TNIL:
                    val = "nil";
                    break;
                default:
                    val = lua.lua_topointer(L, i);
                    break;
                }

                originalLog(i, fengari.to_jsstring(lauxlib.luaL_typename(L, i)), val);
            }
            originalLog('done dumping', name);
        }
    </script>
</body>

</html>
