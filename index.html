<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Lua</title>

    <link rel="stylesheet" href="tachyons.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system,BlinkMacSystemFont,segoe ui,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji,segoe ui symbol;
        }

        button {
            background-color: #484848;
            border: 1px solid #666;
            border-radius: 0.2rem;
            color: white;
        }

        button:hover {
            background-color: #505050;
        }

        button:active {
            background-color: #4a4a4a;
        }

        .flex-fair {
            flex-basis: 1px;
            flex-grow: 1;
            flex-shrink: 1;
        }

        .output-error {
            color: #ff3737;
            font-weight: bold;
        }

        .output-suggestion {
            color: #b7b7ff;
        }

        .output-hint {
            color: #9f9f9f;
            font-style: italic;
        }

        .line-error {
            background: #ff3737;
            width: 4px !important;
            margin-left: 4px;
        }
    </style>

    <script>
        const startValue = window.localStorage.getItem('latest') || 'print("Hello world!")\n';
        const editorConfig = {
            value: startValue,
            language: 'lua',
            theme: 'vs-dark',

            fontSize: 18,
            automaticLayout: true,
            minimap: {
                enabled: false,
            },
            tabSize: 4,
            insertSpaces: true,
            detectIndentation: false,
        };
    </script>
</head>

<body class="white bg-dark-gray">
    <div class="flex absolute absolute--fill pa3">
        <div class="flex-fair flex flex-column overflow-hidden">
            <h2 class="mt0 mb3">Program</h2>
            <div id="program" class="flex-grow-1 overflow-hidden br3"></div>
            <button id="run" class="mt3 pa3">Run</button>
            <button id="stop" class="mt3 pa3 dn">Stop</button>
        </div>
        <div class="flex-fair ml3 flex flex-column">
            <h2 class="mt0 mb3">Output</h2>
            <div class="overflow-auto bg-white-10 pa3 br3 flex-grow-1">
                <pre id="output" class="ma0" style="width: 0"></pre>
            </div>
        </div>
    </div>

    <script src="fengari-web.js"></script>
    <script src="monaco/min/vs/loader.js"></script>
    <script>
        const luaconf  = fengari.luaconf;
        const lua      = fengari.lua;
        const lauxlib  = fengari.lauxlib;
        const lualib   = fengari.lualib;

        const log = console.log;
        function write(str, klass) {
            const safeStr = str.replace(/[&<>]/g, tag => {
                switch (tag) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    default: return tag;
                }
            });
            output.innerHTML += `<span class="${klass}">${safeStr}</span>`;
        }

        // Fengari just calls console.log, so this is what we have to do...
        console.log = (...args) => {
            write(args[0] + '\n');
            log(...args);
        }

        let editor;
        require.config({ paths: { vs: 'monaco/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.querySelector('#program'), editorConfig);
            let oldDecorations = [];
            function setDecorations(decorations) {
                oldDecorations = editor.deltaDecorations(oldDecorations, decorations);
            }
            editor.onDidChangeModelContent(() => {
                window.localStorage.setItem('latest', editor.getValue());
                setDecorations([]);
            });

            const runButton = document.querySelector('#run');
            const stopButton = document.querySelector('#stop');
            const output = document.querySelector('#output');

            function updateUI(running) {
                runButton.classList.toggle('dn', running);
                stopButton.classList.toggle('dn', !running);
            }

            function handleError(errmsg) {
                write(errmsg + '\n', 'output-error');

                const lineNoMatch = errmsg.match(/\[.*\]:(\d+):/);
                if (lineNoMatch) {
                    const lineNo = parseInt(lineNoMatch[1], 10);
                    setDecorations([
                        { range: new monaco.Range(lineNo,1, lineNo,1), options: { isWholeLine: true, linesDecorationsClassName: 'line-error' }},
                    ]);
                }

                if (errmsg.includes("'then' expected")) {
                    write('An if statement should look like "if ... then ... end".\nDid you forget the word "then", or accidentally use "do"?', 'output-suggestion');
                } else if (errmsg.includes("'do' expected near 'then'")) {
                    write('Loops use "do" instead of "then".', 'output-suggestion');
                } else if (errmsg.includes("'do' expected")) {
                    write('Did you forget the word "do" at the start of your loop?', 'output-suggestion');
                }
            }

            let stop;
            function runProgram() {
                output.innerText = '';
                stop = false;
                setDecorations([]);

                updateUI(true);

                function startOrResumeProgram(L) {
                    const resumeResult = lua.lua_resume(L, null, 0);
                    if (resumeResult && resumeResult !== lua.LUA_YIELD) {
                        const errmsg = lua.lua_tojsstring(L, -1);
                        handleError(errmsg);
                        updateUI(false);
                        return;
                    }

                    if (resumeResult === lua.LUA_OK) {
                        write('program finished successfully', 'output-hint');
                        updateUI(false);
                    }
                }

                function hook(L, debug) {
                    if (stop) {
                        lua.lua_yield(L, 0);
                        write('program was stopped', 'output-hint');
                        updateUI(false);
                        return;
                    }

                    lua.lua_yield(L, 0);
                    setTimeout(() => startOrResumeProgram(L), 0);
                }

                try {
                    const L = lauxlib.luaL_newstate();
                    lualib.luaL_openlibs(L);
                    let i = 0;
                    lua.lua_sethook(L, hook, lua.LUA_MASKCOUNT, 1);

                    const loadResult = lauxlib.luaL_loadstring(L, fengari.to_luastring(editor.getValue()));
                    if (loadResult) {
                        const errmsg = lua.lua_tojsstring(L, -1);
                        handleError(errmsg);
                        updateUI(false);
                        return;
                    }

                    startOrResumeProgram(L);
                } catch (e) {
                    console.error(e);
                    updateUI(false);
                }
            }
            function stopProgram() {
                stop = true;
            }

            runButton.addEventListener('click', () => {
                runProgram();
            });
            stopButton.addEventListener('click', () => {
                stopProgram();
            });

            editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.Enter, function() {
                runProgram();
            });
        });

        function dumpstack(L, name) {
            originalLog('dumping stack', name);
            const top = lua.lua_gettop(L);
            for (let i = 1; i <= top; i++) {
                let val;
                switch (lua.lua_type(L, i)) {
                    case lua.LUA_TNUMBER:
                        val = lua.lua_tonumber(L, i);
                        break;
                    case lua.LUA_TSTRING:
                        val = lua.lua_tojsstring(L, i);
                        break;
                    case lua.LUA_TBOOLEAN:
                        val = lua.lua_toboolean(L, i) ? "true" : "false";
                        break;
                    case lua.LUA_TNIL:
                        val = "nil";
                        break;
                    default:
                        val = lua.lua_topointer(L, i);
                        break;
                }

                originalLog(i, fengari.to_jsstring(lauxlib.luaL_typename(L, i)), val);
            }
            originalLog('done dumping', name);
        }
    </script>
</body>

</html>
